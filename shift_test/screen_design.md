# シフト管理システム 画面設計書

> **バージョン**: 1.0
> **作成日**: 2026-02-17
> **データベーススキーマ**: shift_database_schema_v9.md 準拠

---

## 目次

1. [技術スタック定義](#1-技術スタック定義)
2. [ナビゲーション構造](#2-ナビゲーション構造)
3. [画面設計](#3-画面設計)
   - [画面A: 従業員一覧](#画面a-従業員一覧-employees)
   - [画面B: 従業員詳細](#画面b-従業員詳細-employeesid)
   - [画面C: グループ管理](#画面c-グループ管理-groups)
   - [画面D: シフトカレンダー](#画面d-シフトカレンダー-shifts)
   - [画面E: シフト編集ダイアログ](#画面e-シフト編集ダイアログ)
   - [画面F: シフト変更履歴](#画面f-シフト変更履歴-shiftshistory)
4. [コンポーネント一覧](#4-コンポーネント一覧)
5. [APIエンドポイント一覧](#5-apiエンドポイント一覧)
6. [Prismaスキーマ](#6-prismaスキーマ)
7. [データフロー・状態管理](#7-データフロー状態管理)

---

## 1. 技術スタック定義

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| フレームワーク | Next.js (App Router) | 16 | フルスタックフレームワーク |
| UI ライブラリ | React | 19 | UIコンポーネント |
| 言語 | TypeScript | 5.x | 型安全な開発 |
| UIコンポーネント | shadcn/ui | latest | デザインシステム |
| CSS | Tailwind CSS | 4 | ユーティリティファーストCSS |
| アイコン | Lucide React | latest | アイコンセット |
| ORM | Prisma | latest | PostgreSQL ORM |
| 日付処理 | date-fns | latest | 日付フォーマット・計算 |
| フォーム | react-hook-form | latest | フォーム状態管理 |
| バリデーション | zod | latest | スキーマバリデーション |
| URLパラメータ | nuqs | latest | URLクエリパラメータ管理 |
| DB | PostgreSQL | 16 | リレーショナルDB |

**言語設定**: 全UIテキストは日本語

---

## 2. ナビゲーション構造

### ルート構成

```
/                     → ダッシュボード（将来拡張用）
/employees            → 従業員一覧
/employees/[id]       → 従業員詳細（タブ: 基本情報/役割管理/氏名履歴）
/groups               → グループ管理
/shifts               → シフトカレンダー（月次表示）
/shifts/history       → シフト変更履歴
```

### サイドバーレイアウト

shadcn/ui の `Sidebar` コンポーネントを使用。3セクションで構成する。

```
┌──────────────────────────────────────────────────────────────────┐
│ ┌──────────┐ ┌─────────────────────────────────────────────────┐ │
│ │          │ │  AppHeader                                      │ │
│ │  App     │ ├─────────────────────────────────────────────────┤ │
│ │  Sidebar │ │                                                 │ │
│ │          │ │  メインコンテンツエリア                            │ │
│ │ ┌──────┐ │ │                                                 │ │
│ │ │ロゴ  │ │ │                                                 │ │
│ │ └──────┘ │ │                                                 │ │
│ │          │ │                                                 │ │
│ │ ダッシュ  │ │                                                 │ │
│ │ ボード   │ │                                                 │ │
│ │          │ │                                                 │ │
│ │ ユーザー  │ │                                                 │ │
│ │ 管理 ▼   │ │                                                 │ │
│ │  従業員  │ │                                                 │ │
│ │  グループ │ │                                                 │ │
│ │          │ │                                                 │ │
│ │ シフト   │ │                                                 │ │
│ │ 管理 ▼   │ │                                                 │ │
│ │  カレンダー│ │                                                 │ │
│ │  変更履歴 │ │                                                 │ │
│ │          │ │                                                 │ │
│ └──────────┘ └─────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

### サイドバーメニュー構造

| セクション | メニュー項目 | アイコン | パス |
|-----------|------------|---------|------|
| — | ダッシュボード | `LayoutDashboard` | `/` |
| ユーザー管理 | 従業員 | `Users` | `/employees` |
| ユーザー管理 | グループ | `Building2` | `/groups` |
| シフト管理 | カレンダー | `Calendar` | `/shifts` |
| シフト管理 | 変更履歴 | `History` | `/shifts/history` |

---

## 3. 画面設計

---

### 画面A: 従業員一覧 `/employees`

#### 画面概要

従業員の一覧表示・検索・フィルタリングを行う画面。新規従業員の登録もここから開始する。

#### ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────────────┐
│ PageHeader                                                      │
│ ┌───────────────────────────────────┐  ┌──────────────────────┐ │
│ │ 👥 従業員一覧                      │  │ ＋ 新規登録          │ │
│ │ 176名の従業員                      │  └──────────────────────┘ │
│ └───────────────────────────────────┘                            │
├─────────────────────────────────────────────────────────────────┤
│ EmployeeFilters                                                 │
│ ┌──────────────────────┐ ┌──────────┐ ┌────────┐ ┌───────────┐ │
│ │ 🔍 氏名・フリガナで検索 │ │グループ ▼│ │状態 ▼  │ │ 役割 ▼   │ │
│ └──────────────────────┘ └──────────┘ └────────┘ └───────────┘ │
├─────────────────────────────────────────────────────────────────┤
│ EmployeeTable                                                   │
│ ┌────┬────────────┬──────────┬──────────┬──────────┬─────────┐ │
│ │    │ 氏名 ↕     │ グループ │ 役割     │ 配属日   │ 状態    │ │
│ ├────┼────────────┼──────────┼──────────┼──────────┼─────────┤ │
│ │ □  │ 田中 太郎  │ Aグループ│ [受付]   │2024/04/01│ ● 在籍  │ │
│ │    │ ﾀﾅｶ ﾀﾛｳ   │          │ [SV]     │          │         │ │
│ ├────┼────────────┼──────────┼──────────┼──────────┼─────────┤ │
│ │ □  │ 鈴木 花子  │ Bグループ│ [二次対応]│2023/10/15│ ● 在籍  │ │
│ │    │ ｽｽﾞｷ ﾊﾅｺ  │          │ [課長]   │          │         │ │
│ ├────┼────────────┼──────────┼──────────┼──────────┼─────────┤ │
│ │ □  │ 佐藤 一郎  │ Cグループ│ [受付]   │2022/07/01│ ○ 退職  │ │
│ │    │ ｻﾄｳ ｲﾁﾛｳ  │          │          │          │         │ │
│ └────┴────────────┴──────────┴──────────┴──────────┴─────────┘ │
│                                                                 │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ ← 前へ   1  2  3  ...  9   次へ →    20件/ページ ▼        │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### コンポーネント構成

```
EmployeesPage (Server Component)
├── PageHeader（タイトル + 新規登録ボタン）
├── EmployeeFilters (Client Component)
│   ├── SearchInput（氏名・フリガナ検索）
│   ├── Select（グループフィルタ）
│   ├── Select（在籍状態フィルタ: 全て / 在籍中 / 退職済）
│   └── Select（役割フィルタ）
└── EmployeeTable (Client Component)
    ├── Table（shadcn/ui Table）
    │   ├── TableHeader（ソート対応カラム）
    │   └── TableBody → TableRow（各従業員行）
    │       ├── 氏名セル（name + name_kana 2行表示）
    │       ├── グループバッジ
    │       ├── 役割バッジ群（RoleTypeBadge × N）
    │       ├── 配属日
    │       └── StatusBadge（在籍 / 退職）
    └── Pagination（ページネーション）
```

#### インタラクション仕様

| 操作 | 動作 | 詳細 |
|------|------|------|
| 検索入力 | デバウンス検索（300ms） | 氏名・フリガナの部分一致。URLパラメータ `?q=` で状態管理 |
| グループフィルタ変更 | テーブル再取得 | URLパラメータ `?group=` |
| 状態フィルタ変更 | テーブル再取得 | URLパラメータ `?status=active\|inactive\|all` |
| 役割フィルタ変更 | テーブル再取得 | URLパラメータ `?role=` |
| カラムヘッダクリック | ソート切替（昇順/降順） | URLパラメータ `?sort=name&order=asc` |
| 行クリック | 従業員詳細へ遷移 | `/employees/[id]` へ router.push |
| 新規登録ボタン | 新規登録ダイアログ表示 | EmployeeCreateDialog を開く |
| ページネーション | ページ切替 | URLパラメータ `?page=` |

#### 新規従業員登録ダイアログ

```
┌──────────────────────────────────────┐
│ 従業員の新規登録                ✕    │
├──────────────────────────────────────┤
│                                      │
│ 氏名 *                               │
│ ┌──────────────────────────────────┐ │
│ │                                  │ │
│ └──────────────────────────────────┘ │
│                                      │
│ フリガナ                              │
│ ┌──────────────────────────────────┐ │
│ │                                  │ │
│ └──────────────────────────────────┘ │
│                                      │
│ グループ *                            │
│ ┌──────────────────────────────────┐ │
│ │ 選択してください             ▼   │ │
│ └──────────────────────────────────┘ │
│                                      │
│ 配属日                                │
│ ┌──────────────────────────────────┐ │
│ │ 📅 yyyy/mm/dd                    │ │
│ └──────────────────────────────────┘ │
│                                      │
│      ┌──────────┐ ┌──────────────┐  │
│      │ キャンセル │ │   登録する   │  │
│      └──────────┘ └──────────────┘  │
└──────────────────────────────────────┘
```

#### バリデーションルール（zod）

```typescript
const employeeCreateSchema = z.object({
  name: z.string().min(1, "氏名は必須です").max(100),
  nameKana: z.string().max(100).optional(),
  groupId: z.number({ required_error: "グループを選択してください" }),
  assignmentDate: z.date().optional(),
});
```

---

### 画面B: 従業員詳細 `/employees/[id]`

#### 画面概要

従業員の詳細情報を表示・編集する画面。3つのタブで基本情報・役割管理・氏名履歴を管理する。

#### ワイヤーフレーム（全体）

```
┌─────────────────────────────────────────────────────────────────┐
│ ← 従業員一覧に戻る                                               │
├─────────────────────────────────────────────────────────────────┤
│ ヘッダー                                                         │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 田中 太郎                                                   │ │
│ │ ﾀﾅｶ ﾀﾛｳ                                                    │ │
│ │ [Aグループ]  [● 在籍]                                       │ │
│ └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│ タブ                                                             │
│ ┌──────────┬──────────┬──────────┐                              │
│ │ 基本情報  │ 役割管理  │ 氏名履歴  │                              │
│ └──────────┴──────────┴──────────┘                              │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │                                                             │ │
│ │  （タブコンテンツ）                                           │ │
│ │                                                             │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### タブ1: 基本情報

表示モードと編集モードを切替可能なフォーム。

```
┌─────────────────────────────────────────────────────────────┐
│                                         ┌──────────────┐   │
│                                         │ ✏️ 編集する   │   │
│                                         └──────────────┘   │
│ ┌───────────────────┬─────────────────────────────────────┐ │
│ │ 氏名              │ 田中 太郎                           │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ フリガナ           │ ﾀﾅｶ ﾀﾛｳ                           │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ グループ           │ Aグループ                           │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ 配属日             │ 2024/04/01                          │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ 退職日             │ —                                   │ │
│ └───────────────────┴─────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**編集モード時:**

```
┌─────────────────────────────────────────────────────────────┐
│ ┌───────────────────┬─────────────────────────────────────┐ │
│ │ 氏名 *            │ ┌─────────────────────────────────┐ │ │
│ │                   │ │ 田中 太郎                       │ │ │
│ │                   │ └─────────────────────────────────┘ │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ フリガナ           │ ┌─────────────────────────────────┐ │ │
│ │                   │ │ ﾀﾅｶ ﾀﾛｳ                        │ │ │
│ │                   │ └─────────────────────────────────┘ │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ グループ *         │ ┌─────────────────────────────┐    │ │
│ │                   │ │ Aグループ               ▼   │    │ │
│ │                   │ └─────────────────────────────┘    │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ 配属日             │ ┌─────────────────────────────┐    │ │
│ │                   │ │ 📅 2024/04/01               │    │ │
│ │                   │ └─────────────────────────────┘    │ │
│ ├───────────────────┼─────────────────────────────────────┤ │
│ │ 退職日             │ ┌─────────────────────────────┐    │ │
│ │                   │ │ 📅 yyyy/mm/dd               │    │ │
│ │                   │ └─────────────────────────────┘    │ │
│ └───────────────────┴─────────────────────────────────────┘ │
│                                                             │
│            ┌──────────┐ ┌──────────────┐                    │
│            │ キャンセル │ │   保存する   │                    │
│            └──────────┘ └──────────────┘                    │
└─────────────────────────────────────────────────────────────┘
```

#### コンポーネント構成（基本情報タブ）

```
EmployeeBasicInfoForm (Client Component)
├── 表示モード
│   ├── DescriptionList（キー・バリュー表示）
│   └── Button（編集する）
└── 編集モード
    ├── Form (react-hook-form)
    │   ├── Input（氏名）
    │   ├── Input（フリガナ）
    │   ├── Select（グループ）
    │   ├── DatePicker（配属日）
    │   └── DatePicker（退職日）
    └── Button群（キャンセル / 保存する）
```

#### タブ2: 役割管理

現在の役割一覧と役割追加機能。

```
┌─────────────────────────────────────────────────────────────┐
│ 現在の役割                              ┌──────────────┐   │
│                                         │ ＋ 役割を追加 │   │
│                                         └──────────────┘   │
│ ┌─────────┬──────────┬───────────┬──────────┬───────────┐  │
│ │ 役割名   │ カテゴリ  │ 主担当    │ 開始日   │ 操作      │  │
│ ├─────────┼──────────┼───────────┼──────────┼───────────┤  │
│ │ 受付     │ 業務役割  │ ●         │2024/04/01│ [終了][削除]│  │
│ ├─────────┼──────────┼───────────┼──────────┼───────────┤  │
│ │ SV      │ 監督権限  │ —         │2024/10/01│ [終了][削除]│  │
│ └─────────┴──────────┴───────────┴──────────┴───────────┘  │
│                                                             │
│ 過去の役割                                                   │
│ ┌─────────┬──────────┬──────────┬──────────┬──────────┐    │
│ │ 役割名   │ カテゴリ  │ 開始日   │ 終了日   │ 期間     │    │
│ ├─────────┼──────────┼──────────┼──────────┼──────────┤    │
│ │ 二次対応 │ 業務役割  │2023/04/01│2024/03/31│ 1年      │    │
│ └─────────┴──────────┴──────────┴──────────┴──────────┘    │
└─────────────────────────────────────────────────────────────┘
```

#### 役割追加ダイアログ（カテゴリ重複制約対応）

```
┌──────────────────────────────────────┐
│ 役割を追加                      ✕    │
├──────────────────────────────────────┤
│                                      │
│ 役割 *                               │
│ ┌──────────────────────────────────┐ │
│ │ 選択してください             ▼   │ │
│ └──────────────────────────────────┘ │
│                                      │
│  ⚠ 「業務役割」カテゴリには既に       │
│   「受付」が割り当てられています。     │
│    追加すると「受付」は終了されます。   │
│                                      │
│ □ 主担当にする                        │
│                                      │
│ 開始日 *                              │
│ ┌──────────────────────────────────┐ │
│ │ 📅 yyyy/mm/dd                    │ │
│ └──────────────────────────────────┘ │
│                                      │
│      ┌──────────┐ ┌──────────────┐  │
│      │ キャンセル │ │   追加する   │  │
│      └──────────┘ └──────────────┘  │
└──────────────────────────────────────┘
```

**カテゴリ重複制約の動作:**

- 役割選択時、選択した役割の `role_type` と同一カテゴリの現行役割がある場合、警告メッセージを表示
- 追加実行時、同一カテゴリの既存役割は自動的に `end_date` を設定して終了扱いにする
- カテゴリ別の制約ルール:

| 既存役割 | 追加する役割 | 結果 |
|---------|------------|------|
| 受付（FUNCTION） | 二次対応（FUNCTION） | 受付を終了 → 二次対応を追加 |
| 受付（FUNCTION） | SV（AUTHORITY） | そのまま追加（異なるカテゴリ） |
| 課長（POSITION） | 副部長（POSITION） | 課長を終了 → 副部長を追加 |
| SV（AUTHORITY） | 受付（FUNCTION） | そのまま追加（異なるカテゴリ） |

#### コンポーネント構成（役割管理タブ）

```
EmployeeRoleManager (Client Component)
├── 現在の役割セクション
│   ├── SectionHeader（+ 役割を追加ボタン）
│   └── Table（現行役割一覧）
│       └── TableRow
│           ├── 役割名
│           ├── RoleTypeBadge（カテゴリバッジ）
│           ├── 主担当マーク
│           ├── 開始日
│           └── ActionButtons（終了 / 削除）
├── 過去の役割セクション
│   └── Table（終了済み役割一覧）
└── RoleAssignDialog (Client Component)
    ├── Select（役割選択）
    ├── Alert（カテゴリ重複警告 — 条件付き表示）
    ├── Checkbox（主担当フラグ）
    └── DatePicker（開始日）
```

#### タブ3: 氏名履歴

タイムライン形式で氏名変更履歴を表示。

```
┌─────────────────────────────────────────────────────────────┐
│ 氏名履歴                                ┌──────────────┐   │
│                                         │ ＋ 改姓を登録 │   │
│                                         └──────────────┘   │
│                                                             │
│  ● 現在 ──────────────────────────────────────────────      │
│  │                                                          │
│  │  田中 太郎（ﾀﾅｶ ﾀﾛｳ）                                    │
│  │  2025/04/01 〜 現在                                      │
│  │  備考: 結婚に伴う改姓                                     │
│  │                                                          │
│  ○ ─────────────────────────────────────────────────        │
│  │                                                          │
│  │  山田 太郎（ﾔﾏﾀﾞ ﾀﾛｳ）                                    │
│  │  2024/04/01 〜 2025/03/31                                │
│  │                                                          │
│  ○ ─────────────────────────────────────────────────        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 改姓登録ダイアログ

```
┌──────────────────────────────────────┐
│ 改姓を登録                      ✕    │
├──────────────────────────────────────┤
│                                      │
│ 新しい氏名 *                          │
│ ┌──────────────────────────────────┐ │
│ │                                  │ │
│ └──────────────────────────────────┘ │
│                                      │
│ 新しいフリガナ                        │
│ ┌──────────────────────────────────┐ │
│ │                                  │ │
│ └──────────────────────────────────┘ │
│                                      │
│ 変更日（有効開始日） *                 │
│ ┌──────────────────────────────────┐ │
│ │ 📅 yyyy/mm/dd                    │ │
│ └──────────────────────────────────┘ │
│                                      │
│ 備考                                  │
│ ┌──────────────────────────────────┐ │
│ │ 例: 結婚に伴う改姓               │ │
│ └──────────────────────────────────┘ │
│                                      │
│  ⓘ 登録すると従業員マスタの氏名も     │
│    自動的に更新されます。             │
│                                      │
│      ┌──────────┐ ┌──────────────┐  │
│      │ キャンセル │ │   登録する   │  │
│      └──────────┘ └──────────────┘  │
└──────────────────────────────────────┘
```

#### コンポーネント構成（氏名履歴タブ）

```
EmployeeNameHistory (Client Component)
├── SectionHeader（+ 改姓を登録ボタン）
├── Timeline（タイムライン表示）
│   └── TimelineItem × N
│       ├── StatusIndicator（● 現在 / ○ 過去）
│       ├── 氏名（name + name_kana）
│       ├── 有効期間（valid_from 〜 valid_to）
│       └── 備考（note）
└── NameChangeDialog (Client Component)
    ├── Input（新しい氏名）
    ├── Input（新しいフリガナ）
    ├── DatePicker（変更日）
    └── Textarea（備考）
```

**改姓登録時の処理フロー:**

1. 新しい氏名履歴レコードを `employee_name_history` に追加（`is_current = true`）
2. 既存の現行レコードの `is_current = false`、`valid_to` を変更日の前日に設定
3. `employees` テーブルの `name`、`name_kana` を新しい氏名で更新

---

### 画面C: グループ管理 `/groups`

#### 画面概要

グループマスタのシンプルなCRUD管理画面。現在3グループが登録されている。

#### ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────────────┐
│ PageHeader                                                      │
│ ┌───────────────────────────────────┐  ┌──────────────────────┐ │
│ │ 🏢 グループ管理                    │  │ ＋ グループを追加     │ │
│ │ 3件のグループ                      │  └──────────────────────┘ │
│ └───────────────────────────────────┘                            │
├─────────────────────────────────────────────────────────────────┤
│ GroupTable                                                      │
│ ┌────┬──────────────────┬───────────┬───────────────────────┐  │
│ │ ID │ グループ名        │ 所属人数  │ 操作                  │  │
│ ├────┼──────────────────┼───────────┼───────────────────────┤  │
│ │ 1  │ Aグループ        │ 62名      │ [✏️ 編集] [🗑️ 削除]   │  │
│ ├────┼──────────────────┼───────────┼───────────────────────┤  │
│ │ 2  │ Bグループ        │ 58名      │ [✏️ 編集] [🗑️ 削除]   │  │
│ ├────┼──────────────────┼───────────┼───────────────────────┤  │
│ │ 3  │ Cグループ        │ 56名      │ [✏️ 編集] [🗑️ 削除]   │  │
│ └────┴──────────────────┴───────────┴───────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

#### グループ追加/編集ダイアログ

```
┌──────────────────────────────────────┐
│ グループを追加 / グループを編集  ✕    │
├──────────────────────────────────────┤
│                                      │
│ グループ名 *                          │
│ ┌──────────────────────────────────┐ │
│ │                                  │ │
│ └──────────────────────────────────┘ │
│                                      │
│      ┌──────────┐ ┌──────────────┐  │
│      │ キャンセル │ │   保存する   │  │
│      └──────────┘ └──────────────┘  │
└──────────────────────────────────────┘
```

#### 削除確認ダイアログ

```
┌──────────────────────────────────────┐
│ ⚠ グループの削除                 ✕   │
├──────────────────────────────────────┤
│                                      │
│ 「Aグループ」を削除しますか？          │
│                                      │
│  ⚠ このグループには62名の従業員が      │
│    所属しています。削除できません。     │
│                                      │
│  ─── または ───                       │
│                                      │
│  このグループに所属する従業員は         │
│  いません。削除してもよろしいですか？   │
│                                      │
│      ┌──────────┐ ┌──────────────┐  │
│      │ キャンセル │ │   削除する   │  │
│      └──────────┘ └──────────────┘  │
└──────────────────────────────────────┘
```

#### コンポーネント構成

```
GroupsPage (Server Component)
├── PageHeader（タイトル + グループ追加ボタン）
└── GroupTable (Client Component)
    ├── Table（shadcn/ui Table）
    │   └── TableRow
    │       ├── ID
    │       ├── グループ名
    │       ├── 所属人数（集計値）
    │       └── ActionButtons（編集 / 削除）
    ├── GroupEditDialog（追加/編集ダイアログ）
    └── ConfirmDialog（削除確認ダイアログ）
```

#### インタラクション仕様

| 操作 | 動作 | 詳細 |
|------|------|------|
| グループ追加 | ダイアログ表示 | グループ名入力 → 保存 |
| 編集ボタン | ダイアログ表示（既存値セット） | グループ名編集 → 保存 |
| 削除ボタン | 確認ダイアログ表示 | 所属人数 > 0 の場合は削除不可メッセージ |
| グループ名バリデーション | ユニーク制約チェック | 重複時エラー「このグループ名は既に使用されています」 |

---

### 画面D: シフトカレンダー `/shifts`

#### 画面概要

月次のシフトカレンダーをグリッド表示する画面。従業員×日付のマトリクスでシフト情報を表示・編集する。

#### ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ PageHeader                                                                      │
│ ┌─────────────────────────────────────┐                                         │
│ │ 📅 シフトカレンダー                   │                                         │
│ └─────────────────────────────────────┘                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│ ShiftCalendarControls                                                           │
│ ┌────┐ ┌──────────────────┐ ┌────┐  ┌──────────┐  ┌──────┐  ┌──────────────┐  │
│ │ ◀  │ │  2026年 2月       │ │ ▶  │  │グループ ▼│  │今月  │  │ 凡例 ▼       │  │
│ └────┘ └──────────────────┘ └────┘  └──────────┘  └──────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────────────────────────────┤
│ ShiftCalendarGrid                                                               │
│ ┌──────────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬────────┐  │
│ │ 従業員    │ 2/1  │ 2/2  │ 2/3  │ 2/4  │ 2/5  │ 2/6  │ 2/7  │ 2/8  │ ...    │  │
│ │          │ (日) │ (月) │ (火) │ (水) │ (木) │ (金) │ (土) │ (日) │        │  │
│ ├──────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────────┤  │
│ │▼ Aグループ                                                                │  │
│ ├──────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────────┤  │
│ │ 田中太郎  │ 休   │ A    │ A    │ A    │ A    │ A    │ 休   │ 休   │        │  │
│ │          │      │09-18 │09-18 │09-18 │09-18 │09-18 │      │      │        │  │
│ │          │      │      │ 🏠   │      │ 🏠   │      │      │      │        │  │
│ ├──────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────────┤  │
│ │ 鈴木花子  │ 休   │ B    │ B    │ 有   │ B    │ B    │ 休   │ 休   │        │  │
│ │          │      │10-19 │10-19 │      │10-19 │10-19 │      │      │        │  │
│ ├──────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────────┤  │
│ │▼ Bグループ                                                                │  │
│ ├──────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼────────┤  │
│ │ 佐藤一郎  │ 休   │ A    │ A    │ A    │ A    │ A    │ 休   │ 休   │        │  │
│ │          │      │09-18 │09-18 │09-18 │09-18 │09-18 │      │      │        │  │
│ └──────────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴────────┘  │
│                                                                                 │
│ ← → スクロール（横方向）                                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│ ShiftCodeLegend（凡例パネル — 展開時）                                            │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │ A: 通常勤務(09:00-18:00)  B: 遅番(10:00-19:00)  休: 休日                  │ │
│ │ 有: 有給休暇  🏠: テレワーク                                                │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### セル表示仕様（ShiftCell）

各セルはシフト情報を凝縮して表示する。

```
┌──────────┐
│ [コード] │  ← シフトコード（A, B, 休, 有 等）
│ HH:MM-   │  ← 開始時刻-終了時刻（短縮形）
│ HH:MM    │
│ [🏠][有] │  ← バッジ（テレワーク / 有給）
└──────────┘
```

**セル背景色:**

| 状態 | 背景色 | 説明 |
|------|--------|------|
| 通常勤務 | `bg-white` | デフォルト |
| 休日（is_holiday） | `bg-gray-100` | 薄いグレー |
| 有給休暇（is_paid_leave） | `bg-blue-50` | 薄いブルー |
| テレワーク（is_remote） | `bg-green-50` | 薄いグリーン |
| 土曜日列 | `bg-blue-50/30` | 列全体に薄いブルー |
| 日曜日列 | `bg-red-50/30` | 列全体に薄いレッド |

#### セルクリック → ポップオーバー（ShiftCellPopover）

```
┌──────────────────────────────────────┐
│ 田中太郎 — 2026/02/03 (火)           │
├──────────────────────────────────────┤
│ シフトコード: A                       │
│ 時間: 09:00 〜 18:00                  │
│ テレワーク: あり 🏠                    │
│ 有給: なし                            │
│ 休日: なし                            │
├──────────────────────────────────────┤
│         ┌──────────────────┐         │
│         │    ✏️ 編集する    │         │
│         └──────────────────┘         │
└──────────────────────────────────────┘
```

#### 一括編集モード

セル範囲を選択（ドラッグ or Shift+クリック）すると、フローティングバーが表示される。

```
┌─────────────────────────────────────────────────────────────────┐
│ ShiftBulkEditBar (フローティング — 画面下部固定)                   │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 3名 × 5日 = 15セル選択中                                    │ │
│ │                                                             │ │
│ │ シフトコード ┌────────┐  □ テレワーク  □ 有給               │ │
│ │             │  A  ▼  │                                     │ │
│ │             └────────┘                                     │ │
│ │                                                             │ │
│ │ ┌──────────┐  ┌──────────────┐                             │ │
│ │ │ キャンセル │  │   一括変更   │                             │ │
│ │ └──────────┘  └──────────────┘                             │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### コンポーネント構成

```
ShiftsPage (Server Component)
├── PageHeader
├── ShiftCalendarControls (Client Component)
│   ├── Button（前月 / 次月）
│   ├── MonthDisplay（年月表示）
│   ├── Select（グループフィルタ）
│   ├── Button（今月）
│   └── ShiftCodeLegend（凡例パネル — Collapsible）
└── ShiftCalendarGrid (Client Component)
    ├── StickyHeader（日付ヘッダ行 — 横スクロール固定）
    ├── GroupSection × N（グループごとのセクション — 折りたたみ可）
    │   ├── GroupHeader（折りたたみトグル + グループ名）
    │   └── EmployeeRow × N
    │       ├── EmployeeName（固定列 — 左端固定）
    │       └── ShiftCell × 28~31
    │           └── ShiftCellPopover（クリック時表示）
    ├── ShiftEditDialog（編集ダイアログ）
    └── ShiftBulkEditBar（一括編集フローティングバー）
```

#### インタラクション仕様

| 操作 | 動作 | 詳細 |
|------|------|------|
| 前月/次月ボタン | 月移動 | URLパラメータ `?year=2026&month=2` |
| 今月ボタン | 当月に移動 | URLパラメータをリセット |
| グループフィルタ | 表示グループ切替 | URLパラメータ `?group=` / 全てで全グループ |
| グループヘッダクリック | セクション折りたたみ/展開 | ローカルstate管理 |
| セルクリック | ポップオーバー表示 | シフト詳細 + 編集ボタン |
| ポップオーバー編集ボタン | シフト編集ダイアログ | ShiftEditDialog を開く |
| セル範囲選択 | 一括編集バー表示 | ドラッグ or Shift+クリック |
| 一括変更ボタン | 一括更新実行 | `PUT /api/shifts/bulk` |
| 凡例ボタン | 凡例パネル表示/非表示 | Collapsible の展開/折りたたみ |

---

### 画面E: シフト編集ダイアログ

#### 画面概要

個別のシフトデータを編集するダイアログ。シフトカレンダーからのセルクリック → ポップオーバー → 編集ボタンで表示される。

#### ワイヤーフレーム

```
┌──────────────────────────────────────┐
│ シフトの編集                    ✕    │
│ 田中太郎 — 2026/02/03 (火)           │
├──────────────────────────────────────┤
│                                      │
│ シフトコード                          │
│ ┌──────────────────────────────────┐ │
│ │ A                                │ │
│ └──────────────────────────────────┘ │
│ ※ 自由入力（例: A, B, C, 夜, 休）    │
│                                      │
│ 開始時刻            終了時刻          │
│ ┌───────────────┐ ┌───────────────┐ │
│ │ 09:00         │ │ 18:00         │ │
│ └───────────────┘ └───────────────┘ │
│                                      │
│ ┌──────────────────────────────────┐ │
│ │ □ 休日        □ 有給休暇         │ │
│ │ □ テレワーク                      │ │
│ └──────────────────────────────────┘ │
│                                      │
│ 変更理由メモ（任意）                   │
│ ┌──────────────────────────────────┐ │
│ │                                  │ │
│ └──────────────────────────────────┘ │
│                                      │
│      ┌──────────┐ ┌──────────────┐  │
│      │ キャンセル │ │   保存する   │  │
│      └──────────┘ └──────────────┘  │
└──────────────────────────────────────┘
```

#### コンポーネント構成

```
ShiftEditDialog (Client Component)
├── DialogHeader
│   ├── タイトル（「シフトの編集」）
│   └── サブタイトル（従業員名 + 日付）
├── Form (react-hook-form)
│   ├── Input（シフトコード — 自由入力）
│   ├── TimeInput × 2（開始時刻 / 終了時刻）
│   ├── Checkbox（休日）
│   ├── Checkbox（有給休暇）
│   ├── Checkbox（テレワーク）
│   └── Textarea（変更理由メモ）
└── DialogFooter
    ├── Button（キャンセル）
    └── Button（保存する）
```

#### バリデーションルール（zod）

```typescript
const shiftEditSchema = z.object({
  shiftCode: z.string().max(20).optional(),
  startTime: z
    .string()
    .regex(/^([01]\d|2[0-3]):[0-5]\d$/, "HH:MM形式で入力してください")
    .optional()
    .nullable(),
  endTime: z
    .string()
    .regex(/^([01]\d|2[0-3]):[0-5]\d$/, "HH:MM形式で入力してください")
    .optional()
    .nullable(),
  isHoliday: z.boolean().default(false),
  isPaidLeave: z.boolean().default(false),
  isRemote: z.boolean().default(false),
  note: z.string().max(255).optional(),
});
```

#### インタラクション仕様

| 操作 | 動作 | 詳細 |
|------|------|------|
| 休日チェック ON | 時刻フィールドを無効化 | 休日は時刻不要 |
| 有給チェック ON | 時刻フィールドを無効化 | 有給は時刻不要 |
| 保存ボタン | `PUT /api/shifts/[id]` | 成功時ダイアログ閉じ + カレンダー再取得 |
| 変更理由メモ | `shift_change_history.note` に保存 | トリガーで履歴自動記録後、note をUPDATE |

---

### 画面F: シフト変更履歴 `/shifts/history`

#### 画面概要

シフトデータの変更履歴を検索・閲覧する画面。変更前後の比較表示と特定バージョンへの復元機能を持つ。

#### ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ PageHeader                                                                  │
│ ┌─────────────────────────────────────┐                                     │
│ │ 📋 シフト変更履歴                     │                                     │
│ └─────────────────────────────────────┘                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ ShiftHistoryFilters                                                         │
│ ┌──────────────────┐ ┌────────────────────────────┐ ┌───────────────────┐  │
│ │ 🔍 従業員名で検索  │ │ 📅 2026/02/01 〜 2026/02/28│ │ 変更種別 ▼        │  │
│ └──────────────────┘ └────────────────────────────┘ └───────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│ ShiftHistoryTable                                                           │
│ ┌────┬──────────┬──────────┬────────┬──────────────────┬─────────────────┐ │
│ │    │ 従業員   │ シフト日付│ 種別   │ 変更内容          │ 変更日時         │ │
│ ├────┼──────────┼──────────┼────────┼──────────────────┼─────────────────┤ │
│ │ ▶  │ 田中太郎 │2026/02/03│ UPDATE │ A 09:00-18:00    │ 2026/02/15      │ │
│ │    │          │          │        │ → B 10:00-19:00  │ 14:30:25        │ │
│ ├────┼──────────┼──────────┼────────┼──────────────────┼─────────────────┤ │
│ │ ▶  │ 鈴木花子 │2026/02/05│ UPDATE │ B 10:00-19:00    │ 2026/02/14      │ │
│ │    │          │          │        │ → 有給            │ 09:15:42        │ │
│ └────┴──────────┴──────────┴────────┴──────────────────┴─────────────────┘ │
│                                                                             │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ ← 前へ   1  2  3   次へ →    20件/ページ ▼                             │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 展開行（変更前後の比較表示）

行の展開ボタン（▶）をクリックすると、変更前後の詳細比較が表示される。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ▼  田中太郎  2026/02/03  UPDATE  A→B  2026/02/15 14:30:25                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ │  変更詳細 (Version 3 → 現在)                                             │ │
│ │  ┌──────────────┬──────────────────┬──────────────────┐                  │ │
│ │  │ 項目          │ 変更前            │ 変更後            │                  │ │
│ │  ├──────────────┼──────────────────┼──────────────────┤                  │ │
│ │  │ シフトコード   │ A                │ B  ← 変更        │                  │ │
│ │  ├──────────────┼──────────────────┼──────────────────┤                  │ │
│ │  │ 開始時刻      │ 09:00            │ 10:00  ← 変更    │                  │ │
│ │  ├──────────────┼──────────────────┼──────────────────┤                  │ │
│ │  │ 終了時刻      │ 18:00            │ 19:00  ← 変更    │                  │ │
│ │  ├──────────────┼──────────────────┼──────────────────┤                  │ │
│ │  │ 休日         │ —                │ —                │                  │ │
│ │  ├──────────────┼──────────────────┼──────────────────┤                  │ │
│ │  │ 有給休暇      │ —                │ —                │                  │ │
│ │  ├──────────────┼──────────────────┼──────────────────┤                  │ │
│ │  │ テレワーク    │ あり              │ あり              │                  │ │
│ │  └──────────────┴──────────────────┴──────────────────┘                  │ │
│ │                                                                          │ │
│ │  メモ: シフトBへ変更（本人希望）                                           │ │
│ │                                                                          │ │
│ │               ┌────────────────────────┐                                │ │
│ │               │ 🔄 このバージョンに復元  │                                │ │
│ │               └────────────────────────┘                                │ │
│ │                                                                          │ │
├─────────────────────────────────────────────────────────────────────────────┤
```

#### 復元確認ダイアログ

```
┌──────────────────────────────────────────┐
│ ⚠ シフトの復元                      ✕   │
├──────────────────────────────────────────┤
│                                          │
│ 田中太郎さんの 2026/02/03 のシフトを       │
│ Version 3 の状態に復元しますか？            │
│                                          │
│ ┌──────────────┬───────────────────────┐ │
│ │ シフトコード   │ A                     │ │
│ │ 開始時刻      │ 09:00                 │ │
│ │ 終了時刻      │ 18:00                 │ │
│ │ テレワーク    │ あり                   │ │
│ └──────────────┴───────────────────────┘ │
│                                          │
│  ⓘ 復元操作も変更履歴に記録されます。      │
│                                          │
│        ┌──────────┐ ┌──────────────┐    │
│        │ キャンセル │ │   復元する   │    │
│        └──────────┘ └──────────────┘    │
└──────────────────────────────────────────┘
```

#### コンポーネント構成

```
ShiftHistoryPage (Server Component)
├── PageHeader
├── ShiftHistoryFilters (Client Component)
│   ├── SearchInput（従業員名検索）
│   ├── DateRangePicker（日付範囲）
│   └── Select（変更種別: 全て / UPDATE / DELETE）
└── ShiftHistoryTable (Client Component)
    ├── Table（shadcn/ui Table）
    │   └── Collapsible TableRow
    │       ├── 概要行
    │       │   ├── ExpandButton（▶ / ▼）
    │       │   ├── 従業員名
    │       │   ├── シフト日付
    │       │   ├── 変更種別バッジ（UPDATE: blue / DELETE: red）
    │       │   ├── 変更内容サマリ
    │       │   └── 変更日時
    │       └── 展開行（変更前後比較）
    │           ├── ComparisonTable（変更前後テーブル）
    │           ├── メモ表示
    │           └── Button（このバージョンに復元）
    ├── Pagination
    └── ConfirmDialog（復元確認ダイアログ）
```

#### インタラクション仕様

| 操作 | 動作 | 詳細 |
|------|------|------|
| 従業員名検索 | デバウンス検索（300ms） | URLパラメータ `?q=` |
| 日付範囲変更 | テーブル再取得 | URLパラメータ `?from=&to=` |
| 変更種別フィルタ | テーブル再取得 | URLパラメータ `?type=UPDATE\|DELETE\|all` |
| 展開ボタン（▶） | 展開行表示 | 変更前後の比較テーブルを表示 |
| 復元ボタン | 確認ダイアログ表示 | 復元内容のプレビュー |
| 復元確定 | `POST /api/shifts/[id]/restore` | 復元実行 → 成功トースト → テーブル再取得 |

---

## 4. コンポーネント一覧

### 共通コンポーネント

| コンポーネント名 | ファイルパス | 用途 |
|----------------|------------|------|
| `AppSidebar` | `components/layout/app-sidebar.tsx` | サイドバーナビゲーション |
| `AppHeader` | `components/layout/app-header.tsx` | ヘッダー（パンくずリスト等） |
| `PageHeader` | `components/common/page-header.tsx` | ページタイトル + アクションボタン |
| `SearchInput` | `components/common/search-input.tsx` | デバウンス付き検索入力 |
| `ConfirmDialog` | `components/common/confirm-dialog.tsx` | 確認ダイアログ（削除・復元等） |
| `StatusBadge` | `components/common/status-badge.tsx` | 在籍状態バッジ（在籍: green / 退職: gray） |
| `RoleTypeBadge` | `components/common/role-type-badge.tsx` | 役割カテゴリバッジ（FUNCTION: blue / AUTHORITY: amber / POSITION: purple） |

### 従業員系コンポーネント

| コンポーネント名 | ファイルパス | 用途 |
|----------------|------------|------|
| `EmployeeFilters` | `components/employees/employee-filters.tsx` | 一覧画面のフィルタバー |
| `EmployeeTable` | `components/employees/employee-table.tsx` | 従業員一覧テーブル |
| `EmployeeCreateDialog` | `components/employees/employee-create-dialog.tsx` | 新規従業員登録ダイアログ |
| `EmployeeBasicInfoForm` | `components/employees/employee-basic-info-form.tsx` | 基本情報の表示/編集フォーム |
| `EmployeeRoleManager` | `components/employees/employee-role-manager.tsx` | 役割管理タブ本体 |
| `RoleAssignDialog` | `components/employees/role-assign-dialog.tsx` | 役割追加ダイアログ |
| `EmployeeNameHistory` | `components/employees/employee-name-history.tsx` | 氏名履歴タイムライン |
| `NameChangeDialog` | `components/employees/name-change-dialog.tsx` | 改姓登録ダイアログ |

### グループ系コンポーネント

| コンポーネント名 | ファイルパス | 用途 |
|----------------|------------|------|
| `GroupTable` | `components/groups/group-table.tsx` | グループ一覧テーブル |
| `GroupEditDialog` | `components/groups/group-edit-dialog.tsx` | グループ追加/編集ダイアログ |

### シフト系コンポーネント

| コンポーネント名 | ファイルパス | 用途 |
|----------------|------------|------|
| `ShiftCalendarControls` | `components/shifts/shift-calendar-controls.tsx` | カレンダー操作バー（月移動・フィルタ） |
| `ShiftCalendarGrid` | `components/shifts/shift-calendar-grid.tsx` | カレンダーグリッド本体 |
| `ShiftCell` | `components/shifts/shift-cell.tsx` | 個別シフトセル |
| `ShiftCellPopover` | `components/shifts/shift-cell-popover.tsx` | セルクリック時のポップオーバー |
| `ShiftEditDialog` | `components/shifts/shift-edit-dialog.tsx` | シフト編集ダイアログ |
| `ShiftBulkEditBar` | `components/shifts/shift-bulk-edit-bar.tsx` | 一括編集フローティングバー |
| `ShiftCodeLegend` | `components/shifts/shift-code-legend.tsx` | シフトコード凡例パネル |
| `ShiftHistoryTable` | `components/shifts/shift-history-table.tsx` | 変更履歴テーブル |
| `ShiftHistoryFilters` | `components/shifts/shift-history-filters.tsx` | 変更履歴フィルタバー |

---

## 5. APIエンドポイント一覧

### 従業員関連

#### `GET /api/employees`

従業員一覧を検索・フィルタ付きで取得する。

**クエリパラメータ:**

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `q` | string | — | 氏名・フリガナの部分一致検索 |
| `group` | number | — | グループIDでフィルタ |
| `status` | `active` \| `inactive` \| `all` | — | 在籍状態フィルタ（デフォルト: `active`） |
| `role` | number | — | 機能役割IDでフィルタ |
| `sort` | string | — | ソートカラム（デフォルト: `name`） |
| `order` | `asc` \| `desc` | — | ソート方向（デフォルト: `asc`） |
| `page` | number | — | ページ番号（デフォルト: `1`） |
| `limit` | number | — | 1ページあたりの件数（デフォルト: `20`） |

**レスポンス:**

```typescript
{
  data: {
    id: number;
    name: string;
    nameKana: string | null;
    group: { id: number; name: string } | null;
    roles: {
      id: number;
      roleName: string;
      roleType: "FUNCTION" | "AUTHORITY" | "POSITION";
      isPrimary: boolean;
    }[];
    assignmentDate: string | null;   // ISO date
    terminationDate: string | null;  // ISO date
    isActive: boolean;               // 在籍中かどうか
  }[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

---

#### `POST /api/employees`

従業員を新規登録する。

**リクエストボディ:**

```typescript
{
  name: string;           // 必須
  nameKana?: string;
  groupId: number;        // 必須
  assignmentDate?: string; // ISO date
}
```

**レスポンス:** `201 Created` — 作成された従業員オブジェクト

---

#### `GET /api/employees/[id]`

従業員の詳細情報を取得する。

**レスポンス:**

```typescript
{
  id: number;
  name: string;
  nameKana: string | null;
  group: { id: number; name: string } | null;
  assignmentDate: string | null;
  terminationDate: string | null;
  isActive: boolean;
  roles: {
    id: number;
    functionRoleId: number;
    roleName: string;
    roleCode: string;
    roleType: "FUNCTION" | "AUTHORITY" | "POSITION";
    isPrimary: boolean;
    startDate: string | null;
    endDate: string | null;
  }[];
  nameHistory: {
    id: number;
    name: string;
    nameKana: string | null;
    validFrom: string;
    validTo: string | null;
    isCurrent: boolean;
    note: string | null;
    createdAt: string;
  }[];
}
```

---

#### `PUT /api/employees/[id]`

従業員の基本情報を更新する。

**リクエストボディ:**

```typescript
{
  name?: string;
  nameKana?: string;
  groupId?: number;
  assignmentDate?: string | null;
  terminationDate?: string | null;
}
```

**レスポンス:** `200 OK` — 更新された従業員オブジェクト

---

#### `GET /api/employees/[id]/roles`

従業員の役割一覧を取得する（現行 + 過去）。

**レスポンス:**

```typescript
{
  current: {
    id: number;
    functionRoleId: number;
    roleName: string;
    roleCode: string;
    roleType: "FUNCTION" | "AUTHORITY" | "POSITION";
    isPrimary: boolean;
    startDate: string | null;
  }[];
  past: {
    id: number;
    functionRoleId: number;
    roleName: string;
    roleCode: string;
    roleType: "FUNCTION" | "AUTHORITY" | "POSITION";
    isPrimary: boolean;
    startDate: string | null;
    endDate: string;
  }[];
}
```

---

#### `POST /api/employees/[id]/roles`

従業員に役割を追加する。同一カテゴリの既存役割がある場合は自動終了。

**リクエストボディ:**

```typescript
{
  functionRoleId: number;  // 必須
  isPrimary?: boolean;     // デフォルト: false
  startDate: string;       // 必須、ISO date
}
```

**処理フロー:**

1. `function_roles` から `role_type` を取得
2. 同一 `role_type` の現行役割（`end_date IS NULL`）が存在するか確認
3. 存在する場合、既存役割の `end_date` を `startDate - 1日` で更新
4. 新しい `employee_function_roles` レコードを作成

**レスポンス:** `201 Created`

---

#### `PUT /api/employees/[id]/roles/[roleId]`

従業員の役割を更新する（主担当フラグ変更など）。

**リクエストボディ:**

```typescript
{
  isPrimary?: boolean;
  endDate?: string;  // 役割を終了する場合
}
```

**レスポンス:** `200 OK`

---

#### `DELETE /api/employees/[id]/roles/[roleId]`

従業員の役割割当を削除する。

**レスポンス:** `204 No Content`

---

#### `GET /api/employees/[id]/name-history`

従業員の氏名変更履歴を取得する。

**レスポンス:**

```typescript
{
  id: number;
  name: string;
  nameKana: string | null;
  validFrom: string;
  validTo: string | null;
  isCurrent: boolean;
  note: string | null;
  createdAt: string;
}[]
```

---

#### `POST /api/employees/[id]/name-history`

従業員の改姓を登録する。

**リクエストボディ:**

```typescript
{
  name: string;          // 必須
  nameKana?: string;
  validFrom: string;     // 必須、ISO date
  note?: string;
}
```

**処理フロー:**

1. 現行の氏名履歴レコード（`is_current = true`）の `is_current` を `false`、`valid_to` を `validFrom - 1日` に更新
2. 新しい氏名履歴レコードを作成（`is_current = true`、`valid_to = NULL`）
3. `employees` テーブルの `name`、`name_kana` を新しい値で更新
4. トランザクションで一括実行

**レスポンス:** `201 Created`

---

### グループ関連

#### `GET /api/groups`

グループ一覧を所属人数付きで取得する。

**レスポンス:**

```typescript
{
  id: number;
  name: string;
  employeeCount: number;  // 在籍中の所属人数
}[]
```

---

#### `POST /api/groups`

グループを新規作成する。

**リクエストボディ:**

```typescript
{
  name: string;  // 必須、ユニーク
}
```

**レスポンス:** `201 Created`

---

#### `PUT /api/groups/[id]`

グループ名を更新する。

**リクエストボディ:**

```typescript
{
  name: string;  // 必須、ユニーク
}
```

**レスポンス:** `200 OK`

---

#### `DELETE /api/groups/[id]`

グループを削除する。

**制約:** 在籍中の所属従業員が存在する場合は `409 Conflict` を返す。

**レスポンス:** `204 No Content` / `409 Conflict`

---

### 機能役割関連

#### `GET /api/function-roles`

機能役割マスタの一覧を取得する。

**レスポンス:**

```typescript
{
  id: number;
  roleCode: string;
  roleName: string;
  roleType: "FUNCTION" | "AUTHORITY" | "POSITION";
  isActive: boolean;
}[]
```

---

### シフト関連

#### `GET /api/shifts`

月次のシフトデータを取得する。

**クエリパラメータ:**

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `year` | number | ○ | 年 |
| `month` | number | ○ | 月（1-12） |
| `group` | number | — | グループIDでフィルタ |

**レスポンス:**

```typescript
{
  year: number;
  month: number;
  daysInMonth: number;
  groups: {
    id: number;
    name: string;
    employees: {
      id: number;
      name: string;
      shifts: {
        id: number;
        date: string;          // ISO date
        shiftCode: string | null;
        startTime: string | null;  // HH:MM
        endTime: string | null;    // HH:MM
        isHoliday: boolean;
        isPaidLeave: boolean;
        isRemote: boolean;
      }[];
    }[];
  }[];
}
```

---

#### `POST /api/shifts`

シフトを新規作成する。

**リクエストボディ:**

```typescript
{
  employeeId: number;
  shiftDate: string;        // ISO date
  shiftCode?: string;
  startTime?: string;       // HH:MM
  endTime?: string;         // HH:MM
  isHoliday?: boolean;
  isPaidLeave?: boolean;
  isRemote?: boolean;
}
```

**レスポンス:** `201 Created`

---

#### `PUT /api/shifts/[id]`

シフトを個別更新する。変更はトリガーにより自動的に `shift_change_history` に記録される。

**リクエストボディ:**

```typescript
{
  shiftCode?: string;
  startTime?: string | null;
  endTime?: string | null;
  isHoliday?: boolean;
  isPaidLeave?: boolean;
  isRemote?: boolean;
  note?: string;            // 変更理由メモ（履歴テーブルに保存）
}
```

**処理フロー:**

1. `shifts` テーブルを UPDATE（トリガーにより履歴が自動記録される）
2. `note` が指定されている場合、記録された履歴レコードの `note` を更新

**レスポンス:** `200 OK`

---

#### `PUT /api/shifts/bulk`

シフトを一括更新する。

**リクエストボディ:**

```typescript
{
  shiftIds: number[];        // 対象シフトIDの配列
  updates: {
    shiftCode?: string;
    startTime?: string | null;
    endTime?: string | null;
    isHoliday?: boolean;
    isPaidLeave?: boolean;
    isRemote?: boolean;
  };
  note?: string;             // 一括変更理由メモ
}
```

**処理フロー:**

1. 各シフトIDに対して個別に UPDATE を実行（各UPDATEでトリガーが発火し履歴が記録される）
2. トランザクションで一括実行
3. `note` が指定されている場合、記録された全履歴レコードの `note` を更新

**レスポンス:** `200 OK` — 更新件数

---

#### `GET /api/shifts/history`

シフト変更履歴を検索・取得する。

**クエリパラメータ:**

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `q` | string | — | 従業員名の部分一致検索 |
| `from` | string | — | 開始日（ISO date） |
| `to` | string | — | 終了日（ISO date） |
| `type` | `UPDATE` \| `DELETE` \| `all` | — | 変更種別フィルタ（デフォルト: `all`） |
| `page` | number | — | ページ番号（デフォルト: `1`） |
| `limit` | number | — | 1ページあたりの件数（デフォルト: `20`） |

**レスポンス:**

```typescript
{
  data: {
    id: number;
    shiftId: number;
    employee: { id: number; name: string };
    shiftDate: string;
    changeType: "UPDATE" | "DELETE";
    version: number;
    changedAt: string;
    note: string | null;
    // スナップショット（変更前の値）
    previous: {
      shiftCode: string | null;
      startTime: string | null;
      endTime: string | null;
      isHoliday: boolean;
      isPaidLeave: boolean;
      isRemote: boolean;
    };
    // 現在の値（shiftsテーブルから取得）
    current: {
      shiftCode: string | null;
      startTime: string | null;
      endTime: string | null;
      isHoliday: boolean;
      isPaidLeave: boolean;
      isRemote: boolean;
    } | null;  // DELETEの場合はnull
  }[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

---

#### `POST /api/shifts/[id]/restore`

シフトを特定バージョンの状態に復元する。

**リクエストボディ:**

```typescript
{
  version: number;  // 復元先のバージョン番号
}
```

**処理フロー:**

1. `shift_change_history` から指定バージョンのスナップショットを取得
2. `shifts` テーブルを UPDATE（この UPDATE もトリガーにより履歴に記録される）
3. 復元による履歴レコードの `note` に「Version X からの復元」を自動設定

**レスポンス:** `200 OK`

---

## 6. Prismaスキーマ

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── グループマスタ ───────────────────────────────────────
model Group {
  id        Int        @id @default(autoincrement())
  name      String     @unique @db.VarChar(50)
  employees Employee[]

  @@map("groups")
}

// ─── 従業員マスタ ─────────────────────────────────────────
model Employee {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(100)
  nameKana        String?   @map("name_kana") @db.VarChar(100)
  groupId         Int?      @map("group_id")
  assignmentDate  DateTime? @map("assignment_date") @db.Date
  terminationDate DateTime? @map("termination_date") @db.Date

  group            Group?                    @relation(fields: [groupId], references: [id])
  shifts           Shift[]
  functionRoles    EmployeeFunctionRole[]
  nameHistory      EmployeeNameHistory[]
  externalAccounts EmployeeExternalAccount[]

  @@map("employees")
}

// ─── シフトデータ ─────────────────────────────────────────
model Shift {
  id          Int       @id @default(autoincrement())
  employeeId  Int?      @map("employee_id")
  shiftDate   DateTime  @map("shift_date") @db.Date
  shiftCode   String?   @map("shift_code") @db.VarChar(20)
  startTime   DateTime? @map("start_time") @db.Time()
  endTime     DateTime? @map("end_time") @db.Time()
  isHoliday   Boolean?  @default(false) @map("is_holiday")
  isPaidLeave Boolean?  @default(false) @map("is_paid_leave")
  isRemote    Boolean   @default(false) @map("is_remote")

  employee      Employee?            @relation(fields: [employeeId], references: [id])
  changeHistory ShiftChangeHistory[]

  @@unique([employeeId, shiftDate])
  @@map("shifts")
}

// ─── 機能役割マスタ ───────────────────────────────────────
model FunctionRole {
  id       Int     @id @default(autoincrement())
  roleCode String  @unique @map("role_code") @db.VarChar(20)
  roleName String  @map("role_name") @db.VarChar(50)
  roleType String  @default("FUNCTION") @map("role_type") @db.VarChar(20)
  isActive Boolean? @default(true) @map("is_active")

  employeeRoles EmployeeFunctionRole[]

  @@map("function_roles")
}

// ─── 従業員機能役割 ───────────────────────────────────────
model EmployeeFunctionRole {
  id             Int       @id @default(autoincrement())
  employeeId     Int?      @map("employee_id")
  functionRoleId Int?      @map("function_role_id")
  roleType       String    @default("FUNCTION") @map("role_type") @db.VarChar(20)
  isPrimary      Boolean?  @default(false) @map("is_primary")
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date

  employee     Employee?     @relation(fields: [employeeId], references: [id])
  functionRole FunctionRole? @relation(fields: [functionRoleId], references: [id])

  @@map("employee_function_roles")
}

// ─── 従業員氏名履歴 ───────────────────────────────────────
model EmployeeNameHistory {
  id         Int       @id @default(autoincrement())
  employeeId Int?      @map("employee_id")
  name       String    @db.VarChar(100)
  nameKana   String?   @map("name_kana") @db.VarChar(100)
  validFrom  DateTime  @map("valid_from") @db.Date
  validTo    DateTime? @map("valid_to") @db.Date
  isCurrent  Boolean?  @default(false) @map("is_current")
  note       String?   @db.VarChar(255)
  createdAt  DateTime? @default(now()) @map("created_at")

  employee Employee? @relation(fields: [employeeId], references: [id])

  @@map("employee_name_history")
}

// ─── シフト変更履歴 ───────────────────────────────────────
model ShiftChangeHistory {
  id          Int       @id @default(autoincrement())
  shiftId     Int       @map("shift_id")
  employeeId  Int?      @map("employee_id")
  shiftDate   DateTime  @map("shift_date") @db.Date
  shiftCode   String?   @map("shift_code") @db.VarChar(20)
  startTime   DateTime? @map("start_time") @db.Time()
  endTime     DateTime? @map("end_time") @db.Time()
  isHoliday   Boolean?  @map("is_holiday")
  isPaidLeave Boolean?  @map("is_paid_leave")
  isRemote    Boolean?  @map("is_remote")
  changeType  String    @map("change_type") @db.VarChar(10)
  version     Int
  changedAt   DateTime  @default(now()) @map("changed_at")
  note        String?   @db.VarChar(255)

  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Restrict)

  @@unique([shiftId, version])
  @@index([shiftId, changedAt])
  @@index([employeeId, shiftDate])
  @@map("shift_change_history")
}

// ─── 外部ツールマスタ ─────────────────────────────────────
model ExternalTool {
  id       Int     @id @default(autoincrement())
  toolCode String  @map("tool_code") @db.VarChar(50)
  toolName String  @map("tool_name") @db.VarChar(100)
  isActive Boolean? @default(true) @map("is_active")

  accounts EmployeeExternalAccount[]

  @@map("external_tools")
}

// ─── 従業員外部アカウント ─────────────────────────────────
model EmployeeExternalAccount {
  id             Int     @id @default(autoincrement())
  employeeId     Int?    @map("employee_id")
  externalToolId Int?    @map("external_tool_id")
  externalName   String  @map("external_name") @db.VarChar(100)
  externalId     String? @map("external_id") @db.VarChar(100)
  isActive       Boolean? @default(true) @map("is_active")

  employee     Employee?     @relation(fields: [employeeId], references: [id])
  externalTool ExternalTool? @relation(fields: [externalToolId], references: [id])

  @@map("employee_external_accounts")
}
```

### 補足: Prismaで表現できない制約

以下の制約はPrismaスキーマでは直接表現できないため、SQLマイグレーションで追加する必要がある。

| 制約 | テーブル | 内容 |
|------|---------|------|
| 部分ユニークインデックス① | `employee_function_roles` | `UNIQUE (employee_id, function_role_id) WHERE end_date IS NULL` |
| 部分ユニークインデックス② | `employee_function_roles` | `UNIQUE (employee_id, role_type) WHERE end_date IS NULL` |
| 部分ユニークインデックス | `employee_name_history` | `UNIQUE (employee_id) WHERE is_current = true` |
| EXCLUDE制約 | `employee_name_history` | `EXCLUDE USING GiST (employee_id WITH =, daterange(valid_from, valid_to, '[]') WITH &&)` |
| トリガー | `employee_function_roles` | `role_type` 自動設定トリガー（`set_efr_role_type`） |
| トリガー | `shifts` | シフト変更履歴の自動記録トリガー（`record_shift_change`） |

---

## 7. データフロー・状態管理

### レンダリング戦略

| コンポーネント種別 | レンダリング方式 | データ取得方法 |
|------------------|----------------|--------------|
| ページコンポーネント | Server Component | Prisma 直接クエリ（初期データ） |
| テーブル・リスト | Client Component | `fetch` で API Route 呼び出し |
| フォーム | Client Component | react-hook-form + API Route |
| フィルタ・検索 | Client Component | URLパラメータ変更 → API再取得 |

### 初期データ取得フロー

```
ブラウザ
  │
  ▼
Server Component (RSC)
  │
  ├── Prisma で初期データ取得
  │   └── SELECT ... FROM employees WHERE ... LIMIT 20
  │
  ├── props として Client Component に渡す
  │
  ▼
Client Component
  │
  ├── 初期表示: Server から受け取った props を表示
  │
  ├── フィルタ変更時:
  │   ├── nuqs で URLパラメータ更新
  │   ├── fetch("/api/employees?q=xxx&group=1&page=2")
  │   └── レスポンスで state 更新 → 再描画
  │
  └── フォーム送信時:
      ├── react-hook-form の handleSubmit
      ├── zod バリデーション
      ├── fetch("/api/employees", { method: "POST", body: ... })
      └── 成功時: router.refresh() or 再取得
```

### URLパラメータ（nuqs）による状態管理

各画面のフィルタ・ページネーション状態は URL クエリパラメータで管理し、ブラウザの戻る/進むに対応する。

#### 従業員一覧 `/employees`

```typescript
const searchParams = {
  q: parseAsString.withDefault(""),
  group: parseAsInteger,
  status: parseAsStringLiteral(["active", "inactive", "all"]).withDefault("active"),
  role: parseAsInteger,
  sort: parseAsString.withDefault("name"),
  order: parseAsStringLiteral(["asc", "desc"]).withDefault("asc"),
  page: parseAsInteger.withDefault(1),
};
```

#### シフトカレンダー `/shifts`

```typescript
const searchParams = {
  year: parseAsInteger.withDefault(new Date().getFullYear()),
  month: parseAsInteger.withDefault(new Date().getMonth() + 1),
  group: parseAsInteger,
};
```

#### シフト変更履歴 `/shifts/history`

```typescript
const searchParams = {
  q: parseAsString.withDefault(""),
  from: parseAsString,   // ISO date string
  to: parseAsString,     // ISO date string
  type: parseAsStringLiteral(["UPDATE", "DELETE", "all"]).withDefault("all"),
  page: parseAsInteger.withDefault(1),
};
```

### フォームバリデーション（zod スキーマ一覧）

| スキーマ名 | 使用画面 | 主な制約 |
|-----------|---------|---------|
| `employeeCreateSchema` | 従業員新規登録 | name: 必須, groupId: 必須 |
| `employeeUpdateSchema` | 従業員基本情報編集 | name: 必須 |
| `roleAssignSchema` | 役割追加 | functionRoleId: 必須, startDate: 必須 |
| `nameChangeSchema` | 改姓登録 | name: 必須, validFrom: 必須 |
| `groupSchema` | グループ追加/編集 | name: 必須, ユニーク |
| `shiftEditSchema` | シフト編集 | 時刻: HH:MM形式 |
| `shiftBulkEditSchema` | シフト一括編集 | shiftIds: 1件以上 |

### エラーハンドリング

| エラー種別 | HTTPステータス | UI表示 |
|-----------|--------------|--------|
| バリデーションエラー | 400 | フォームフィールド下にインラインエラーメッセージ |
| 重複制約エラー | 409 | トーストメッセージ（例:「このグループ名は既に使用されています」） |
| 存在しないリソース | 404 | 専用の404ページ or トーストメッセージ |
| 削除制約エラー | 409 | ダイアログ内の警告メッセージ（例:「所属従業員がいるため削除できません」） |
| サーバーエラー | 500 | トーストメッセージ（「予期しないエラーが発生しました」） |

---

## 付録

### RoleTypeBadge 色定義

| role_type | ラベル | 色 | Tailwind クラス |
|-----------|--------|-----|----------------|
| `FUNCTION` | 業務役割 | 青 | `bg-blue-100 text-blue-700` |
| `AUTHORITY` | 監督権限 | 琥珀 | `bg-amber-100 text-amber-700` |
| `POSITION` | 役職 | 紫 | `bg-purple-100 text-purple-700` |

### StatusBadge 色定義

| 状態 | ラベル | 色 | Tailwind クラス |
|------|--------|-----|----------------|
| 在籍中 | ● 在籍 | 緑 | `bg-green-100 text-green-700` |
| 退職済 | ○ 退職 | グレー | `bg-gray-100 text-gray-500` |

### 変更種別バッジ色定義

| change_type | ラベル | 色 | Tailwind クラス |
|-------------|--------|-----|----------------|
| `UPDATE` | 更新 | 青 | `bg-blue-100 text-blue-700` |
| `DELETE` | 削除 | 赤 | `bg-red-100 text-red-700` |

### ディレクトリ構成（参考）

```
src/
├── app/
│   ├── layout.tsx                    # ルートレイアウト（AppSidebar含む）
│   ├── page.tsx                      # ダッシュボード
│   ├── employees/
│   │   ├── page.tsx                  # 従業員一覧
│   │   └── [id]/
│   │       └── page.tsx              # 従業員詳細
│   ├── groups/
│   │   └── page.tsx                  # グループ管理
│   └── shifts/
│       ├── page.tsx                  # シフトカレンダー
│       └── history/
│           └── page.tsx              # シフト変更履歴
├── components/
│   ├── layout/
│   │   ├── app-sidebar.tsx
│   │   └── app-header.tsx
│   ├── common/
│   │   ├── page-header.tsx
│   │   ├── search-input.tsx
│   │   ├── confirm-dialog.tsx
│   │   ├── status-badge.tsx
│   │   └── role-type-badge.tsx
│   ├── employees/
│   │   ├── employee-filters.tsx
│   │   ├── employee-table.tsx
│   │   ├── employee-create-dialog.tsx
│   │   ├── employee-basic-info-form.tsx
│   │   ├── employee-role-manager.tsx
│   │   ├── role-assign-dialog.tsx
│   │   ├── employee-name-history.tsx
│   │   └── name-change-dialog.tsx
│   ├── groups/
│   │   ├── group-table.tsx
│   │   └── group-edit-dialog.tsx
│   ├── shifts/
│   │   ├── shift-calendar-controls.tsx
│   │   ├── shift-calendar-grid.tsx
│   │   ├── shift-cell.tsx
│   │   ├── shift-cell-popover.tsx
│   │   ├── shift-edit-dialog.tsx
│   │   ├── shift-bulk-edit-bar.tsx
│   │   ├── shift-code-legend.tsx
│   │   ├── shift-history-table.tsx
│   │   └── shift-history-filters.tsx
│   └── ui/                           # shadcn/ui コンポーネント
├── lib/
│   ├── prisma.ts                     # Prisma クライアント
│   ├── validations/                  # zod スキーマ
│   │   ├── employee.ts
│   │   ├── group.ts
│   │   └── shift.ts
│   └── utils.ts                      # ユーティリティ
└── prisma/
    ├── schema.prisma
    └── migrations/                   # マイグレーションファイル
```
